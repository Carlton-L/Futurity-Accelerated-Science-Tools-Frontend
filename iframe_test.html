<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chainlit Iframe Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .iframe-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .control-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .json-input {
            font-family: 'Courier New', monospace;
        }
        .message-log {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Chainlit Iframe Message Test</h1>
            </div>
        </div>
        
        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-4">
                <div class="control-panel">
                    <h3>Message Control Panel</h3>
                    
                    <div class="mb-3">
                        <label for="jsonInput" class="form-label">JSON Message:</label>
                        <textarea
                            class="form-control json-input"
                            id="jsonInput"
                            rows="8"
                            placeholder='Enter JSON here, e.g.:
{
  "mode": "expert",
  "subject": "metaverse",
  "subject_fsid": "fsid_metaverse",
  "page": "snapshot page"
}'></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-primary w-100" onclick="sendMessage()">
                            Send Message to Iframe
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-success w-100 mb-2" onclick="loadFullAgencyJSON()">
                            Load Full Agency Mode
                        </button>
                        <button class="btn btn-info w-100 mb-2" onclick="loadExpertJSON()">
                            Load Expert Mode (Metaverse)
                        </button>
                        <button class="btn btn-secondary w-100" onclick="loadSampleJSON()">
                            Load Default Sample
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-info w-100" onclick="validateJSON()">
                            Validate JSON
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-warning w-100" onclick="clearLog()">
                            Clear Message Log
                        </button>
                    </div>
                </div>
                
                <!-- Message Log -->
                <div class="message-log">
                    <h5>Message Log:</h5>
                    <div id="messageLog">
                        <small class="text-muted">Messages sent will appear here...</small>
                    </div>
                </div>
            </div>
            
            <!-- Iframe Container -->
            <div class="col-md-8">
                <div class="iframe-container">
                    <iframe 
                        id="chainlit-iframe" 
                        src="http://agents.futurity.science" 
                        width="100%" 
                        height="600"
                        frameborder="0">
                    </iframe>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Note:</strong> Make sure your Chainlit app is running on <code>http://localhost:8000</code>
                        <br>
                        Run with: <code>chainlit run app.py --port 8000</code>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function sendMessage() {
            const jsonInput = document.getElementById('jsonInput');
            const iframe = document.getElementById('chainlit-iframe');
            const messageLog = document.getElementById('messageLog');
            
            try {
                // Validate JSON first
                const jsonData = JSON.parse(jsonInput.value);
                
                // Convert to string for sending
                const messageString = JSON.stringify(jsonData);
                
                // Send message to iframe
                iframe.contentWindow.postMessage('Client: ' + messageString, '*');
                
                // Log the message
                logMessage('SENT', messageString);
                
                // Show success
                showAlert('Message sent successfully!', 'success');
                
            } catch (error) {
                showAlert('Invalid JSON: ' + error.message, 'danger');
            }
        }
        
        function loadSampleJSON() {
            const sampleJSON = {
                "mode": "expert",
                "subject": "metaverse",
                "subject_fsid": "fsid_metaverse",
                "page": "snapshot page"
            };
            
            document.getElementById('jsonInput').value = JSON.stringify(sampleJSON, null, 2);
        }
        
        function loadFullAgencyJSON() {
            const fullAgencyJSON = {
                "mode": "full-agency",
                "subject": "general",
                "subject_fsid": "fsid_general",
                "page": "main page"
            };
            
            document.getElementById('jsonInput').value = JSON.stringify(fullAgencyJSON, null, 2);
        }
        
        function loadExpertJSON() {
            const expertJSON = {
                "mode": "expert",
                "subject": "metaverse",
                "subject_fsid": "fsid_metaverse",
                "page": "snapshot page"
            };
            
            document.getElementById('jsonInput').value = JSON.stringify(expertJSON, null, 2);
        }
        
        function validateJSON() {
            const jsonInput = document.getElementById('jsonInput');
            
            try {
                JSON.parse(jsonInput.value);
                showAlert('JSON is valid!', 'success');
            } catch (error) {
                showAlert('Invalid JSON: ' + error.message, 'danger');
            }
        }
        
        function clearLog() {
            document.getElementById('messageLog').innerHTML = '<small class="text-muted">Messages sent will appear here...</small>';
        }
        
        function logMessage(type, message) {
            const messageLog = document.getElementById('messageLog');
            const timestamp = new Date().toLocaleTimeString();
            
            // Remove the initial placeholder text
            if (messageLog.innerHTML.includes('Messages sent will appear here...')) {
                messageLog.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2 p-2 border-start border-3 border-primary';
            logEntry.innerHTML = `
                <small class="text-muted">[${timestamp}] ${type}:</small><br>
                <code style="font-size: 0.8em; word-break: break-all;">${message}</code>
            `;
            
            messageLog.appendChild(logEntry);
            messageLog.scrollTop = messageLog.scrollHeight;
        }
        
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alert, container.firstChild);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }
        
        // Listen for messages from the iframe (optional - for debugging)
        window.addEventListener('message', function(event) {
            console.log('Received message from iframe:', event.data);
        });
        
        // Load sample JSON on page load
        window.addEventListener('load', function() {
            loadSampleJSON();
        });
    </script>
</body>
</html>